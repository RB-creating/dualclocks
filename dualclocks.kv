#:kivy 2.3.0
#:import dp kivy.metrics.dp
#:import sp kivy.metrics.sp
#:import Window kivy.core.window.Window
#:import StableSpinner main.StableSpinner

<AnalogClock>:
    size_hint: 1, 1

<ClockPanel>:
    orientation: 'vertical'
    spacing: dp(10)

    # Bind Python properties to these ids (no on_kv_post needed)
    spinner: spinner
    clock: clock

    AnchorLayout:
        anchor_x: 'center'
        anchor_y: 'center'
        AnalogClock:
            id: clock

    StableSpinner:
        id: spinner
        text: 'Select City'
        values: ['Los Angeles', 'San Francisco', 'New York', 'London', 'Paris', 'Berlin', 'Dubai', 'Delhi', 'Beijing', 'Tokyo', 'Sydney', 'Auckland', 'Johannesburg', 'São Paulo', 'Honolulu']
        size_hint_y: None
        height: dp(40)  # <- fixed height avoids layout churn during open/selection
        font_size: sp(max(16, min(24, Window.width * 0.020)))
        background_normal: ''
        background_color: 0.95, 1.0, 0.95, 1
        color: 0.0, 0.0, 0.5, 1
        option_cls: 'SpinnerOption'  # <- ensure our styled options are used
        # Keep one on_text handler (you had two). Avoid calling layout/size computations here.
        on_text: root.set_city(self.text)

        canvas.after:
            Color:
                rgba: self.color
            Line:
                width: dp(1.2)
                rectangle: self.x, self.y, self.width, self.height

        # If app.fit_spinner_font only tweaks font size (not size/pos), you can keep it on on_size:
        on_size: app.fit_spinner_font(self, min_sp=12, max_sp=24)


# Keep SpinnerOption ONLY for styling dropdown options (no layout/content here)
<SpinnerOption>:
    font_size: sp(max(16, min(24, Window.width * 0.020)))

# ---- Root layout stays the same ----
BoxLayout:
    orientation: 'horizontal'
    padding: dp(16)
    spacing: dp(24)

    ClockPanel:
        id: left_panel

    BoxLayout:
        orientation: 'vertical'
        size_hint_x: None
        width: dp(140)
        spacing: dp(8)
        padding: [0, 0]

        Button:
            text: '×'
            size_hint_y: None
            height: dp(28)
            size_hint_x: None
            width: dp(28)
            font_size: '16sp'
            background_normal: ''
            background_color: 1, 0.9, 0.9, 1
            color: 0.4, 0, 0, 1
            opacity: 1 if app.is_android else 0
            disabled: not app.is_android
            on_release: app.request_close()

        Widget:
            size_hint_y: 1

        Label:
            id: delta_label
            text: ''
            color: 0, 0, 0, 1
            font_size: sp(max(18, min(28, Window.width * 0.025)))
            halign: 'center'
            valign: 'middle'
            text_size: self.width, None
            max_lines: 1
            shorten: True
            shorten_from: 'center'
            size_hint_y: None
            height: dp(30)

    ClockPanel:
        id: right_panel
