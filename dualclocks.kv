#:kivy 2.3.0
#:import dp kivy.metrics.dp
#:import sp kivy.metrics.sp
#:import Window kivy.core.window.Window
#:import StableSpinner main.StableSpinner
#:import Factory kivy.factory.Factory

<WideDropDown@DropDown>:
    auto_width: False
    width: min(Window.width * 0.92, dp(420))   # menu up to ~92% of the screen, capped at 420dp
    max_height: dp(320)                        # don't cover the entire screen

#<NoDismissDropDown@DropDown>:
#   auto_dismiss: False

<AnalogClock>:
    size_hint: 1, 1

<ClockPanel>:
    orientation: 'vertical'
    spacing: dp(10)
    spinner: spinner
    clock: clock

    AnchorLayout:
        anchor_x: 'center'
        anchor_y: 'center'
        AnalogClock:
            id: clock

    StableSpinner:
        id: spinner
        text: 'Select City'
        values: ['Los Angeles','San Francisco','New York','London','Paris','Berlin','Dubai','Delhi','Beijing','Tokyo','Sydney','Auckland','Johannesburg','São Paulo','Honolulu']

        # NEW: use the wider dropdown
        dropdown_cls: 'WideDropDown'

        size_hint_y: None
        height: dp(40)
        font_size: sp(max(16, min(24, Window.width * 0.020)))
        background_normal: ''
        background_color: 0.95, 1.0, 0.95, 1
        color: 0.0, 0.0, 0.5, 1
        option_cls: 'SpinnerOption'

        # Refit the button's text whenever selection changes (auto-scale font)
        on_text:
            root.set_city(self.text)
            app.fit_spinner_font(self, 12, 24)

        # Help ellipsize gracefully only if needed after scaling
        shorten: True
        shorten_from: 'right'
        text_size: self.width - dp(16), None

        # Keep refitting on size changes (you already had this)
        on_size: app.fit_spinner_font(self, min_sp=12, max_sp=24)


<SpinnerOption>:
    font_size: sp(max(16, min(24, Window.width * 0.020)))
    size_hint_y: None
    height: dp(44)
    padding: dp(12), 0
    halign: 'left'
    valign: 'middle'
    text_size: self.width - dp(24), None
# ---- Root layout unchanged ----
BoxLayout:
    orientation: 'horizontal'
    padding: dp(16)
    spacing: dp(24)

    ClockPanel:
        id: left_panel

    BoxLayout:
        orientation: 'vertical'
        size_hint_x: None
        width: dp(140)
        spacing: dp(8)
        padding: [0, 0]

        Button:
            text: '×'
            size_hint_y: None
            height: dp(28)
            size_hint_x: None
            width: dp(28)
            font_size: '16sp'
            background_normal: ''
            background_color: 1, 0.9, 0.9, 1
            color: 0.4, 0, 0, 1
            opacity: 1 if app.is_android else 0
            disabled: not app.is_android
            on_release: app.request_close()

        Widget:
            size_hint_y: 1

        Label:
            id: delta_label
            text: ''
            color: 0, 0, 0, 1
            font_size: sp(max(18, min(28, Window.width * 0.025)))
            halign: 'center'
            valign: 'middle'
            text_size: self.width, None
            max_lines: 1
            shorten: True
            shorten_from: 'center'
            size_hint_y: None
            height: dp(30)

    ClockPanel:
        id: right_panel
